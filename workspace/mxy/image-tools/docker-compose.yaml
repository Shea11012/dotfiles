name: image-tools

networks:
  tools:
    driver: bridge

services:
  network-service:
    image: alpine
    container_name: tool-network
    # ports:
    #   - "3001:8080" # openwebui
    command: tail -f /dev/null
    networks:
      - tools

  sub-store:
    image: xream/sub-store:http-meta
    container_name: sub-store
    restart: always
    network_mode: host
    environment:
      SUB_STORE_BACKEND_API_HOST: 127.0.0.1
      SUB_STORE_BACKEND_API_PORT: 3002
      SUB_STORE_FRONTEND_BACKEND_PATH: /cD7wiTGitLyoBdEguAnFWmqCpHKwhLQh4opXfFhFCEpmY9K7YnPgFu9e2iiUoty2
      PORT: 9876
      HOST: 127.0.0.1
    volumes:
      - ./sub-store/data:/opt/app/data

  caddy:
    build: ./caddy
    container_name: caddy-upload
    cap_add:
      - NET_ADMIN
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    environment:
      - PUID=1000
      - PGID=1000
    volumes:
      - ./caddy/conf:/etc/caddy
      - ./caddy/assets:/srv

  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    environment:
      - TZ=Asia/Shanghai
    volumes:
      # - /run/user/1000/docker.sock:/var/run/docker.sock
      - /var/run/docker.sock:/var/run/docker.sock
    command: watchtower sub-store --cleanup --schedule "0 0 1 * * *"
    restart: on-failure:3
    network_mode: "service:network-service"
    # networks:
    #   - tools
