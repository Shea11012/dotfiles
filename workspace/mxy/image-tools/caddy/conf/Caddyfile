{
    order upload before file_server
    log {
        level debug
    }
}

:80 {
    @metacubex {
        header Cookie "*app_context=metacubex*"
    }

    handle_path /assets/* {
        handle @metacubex {
            rewrite * "/assets{uri}"
            header x-Route-by "meteacubex"
            reverse_proxy http://metacubexd 
        }

        root * /srv
        file_server browse
    }

    @mypost method POST
    upload @mypost {
        root_dir /srv
        dest_dir_field_name upload_dir
        response_template templates/upload-resp-template.txt
    }

    handle_path /sub-store {
    	# rewrite * ?api=http://192.168.32.16:3001/cD7wiTGitLyoBdEguAnFWmqCpHKwhLQh4opXfFhFCEpmY9K7YnPgFu9e2iiUoty2
    	redir http://192.168.32.16:3001?api=http://192.168.32.16:3001/cD7wiTGitLyoBdEguAnFWmqCpHKwhLQh4opXfFhFCEpmY9K7YnPgFu9e2iiUoty2
    }

    handle_path /metacubex {
        reverse_proxy http://metacubexd {
            header_down Set-Cookie "app_context=metacubex; Path=/; Max-Age=3600; SameSite=Lax; HttpOnly"
        }
    }
}
